# activate environment
conda activate qiime2-amplicon-2024.2

# move all sequences to a sequence folder and zip them 
gzip sequences/*.fastq

# Rename all files to SRR#NUMBER_15_L001_R2_001.fastq.gz

# create your demux file
# qiime will be told which type of sequences will be read and analyzed
# sequences found in sequence folder 
# format used by Illumina cassava 
# demux file will be created in a .qza format 
qiime tools import \
  --type 'SampleData[PairedEndSequencesWithQuality]' \
  --input-path sequences \
  --input-format CasavaOneEightSingleLanePerSampleDirFmt \
  --output-path demux.qza

# create demux visualization in .qzv format 
qiime demux summarize \
  --i-data demux.qza \
  --o-visualization demux.qzv

# The code its telling qiime to remove any low quality regions from our reads in both forward and reverse reads at different positions. These numbers were picked based on the demux.qzv file. 
# It will visualize the data in the rep sequence and table 
qiime dada2 denoise-paired \
  --i-demultiplexed-seqs demux.qza \
  --p-trim-left-f 30 \
  --p-trunc-len-f 220 \
  --p-trim-left-r 20 \
  --p-trunc-len-r 170 \
  --o-representative-sequences rep-seqs-dada2.qza \
  --o-table table-dada2.qza \
  --o-denoising-stats stats-dada2.qza

# metada tabulate 
qiime metadata tabulate \
  --m-input-file stats-dada2.qza \
  --o-visualization stats-dada2.qzv

# rename files
mv rep-seqs-dada2.qza rep-seqs.qza
mv table-dada2.qza table.qza
mv stats-dada2.qza stats.qza
mv stats-dada2.qzv stats.qzv


# creating visualizations for the table and sequences 
qiime feature-table summarize \
  --i-table table.qza \
  --o-visualization table.qzv \
  --m-sample-metadata-file metadata.txt
qiime feature-table tabulate-seqs \
  --i-data rep-seqs.qza \
  --o-visualization rep-seqs.qzv

wget \
  -O "gg-13-8-99-515-806-nb-classifier.qza" \
  "https://data.qiime2.org/2024.2/common/gg-13-8-99-515-806-nb-classifier.qza"

qiime feature-classifier classify-sklearn \
  --i-classifier gg-13-8-99-515-806-nb-classifier.qza \
  --i-reads rep-seqs.qza \
  --o-classification taxonomy.qza

qiime metadata tabulate \
  --m-input-file taxonomy.qza \
  --o-visualization taxonomy.qzv

qiime taxa filter-table \
  --i-table table.qza \
  --i-taxonomy taxonomy.qza \
  --p-exclude mitochondria,chloroplast \
  --o-filtered-table table.qza

qiime feature-table summarize \
  --i-table table.qza \
  --o-visualization table.qzv \
  --m-sample-metadata-file metadata.txt

qiime feature-classifier classify-sklearn \
  --i-classifier gg-13-8-99-515-806-nb-classifier.qza \
  --i-reads rep-seqs.qza \
  --o-classification taxonomy.qza
qiime metadata tabulate \
  --m-input-file taxonomy.qza \
  --o-visualization taxonomy.qzv

qiime taxa barplot \
  --i-table table.qza \
  --i-taxonomy taxonomy.qza \
  --m-metadata-file metadata.txt \ 
  --o-visualization taxa-bar-plots.qzv

qiime phylogeny align-to-tree-mafft-fasttree \
  --i-sequences rep-seqs.qza \
  --o-alignment aligned-rep-seqs.qza \
  --o-masked-alignment masked-aligned-rep-seqs.qza \
  --o-tree unrooted-tree.qza \
  --o-rooted-tree rooted-tree.qza

qiime diversity core-metrics-phylogenetic \
  --i-phylogeny rooted-tree.qza \
  --i-table table.qza \
  --p-sampling-depth 3876 \
  --m-metadata-file metadata.txt \
  --output-dir core-metrics-results

qiime diversity alpha-group-significance \
  --i-alpha-diversity core-metrics-results/shannon_vector.qza \
  --m-metadata-file metadata.txt \
  --o-visualization core-metrics-results/shannon_vector.qzv
qiime diversity alpha-group-significance \
  --i-alpha-diversity core-metrics-results/observed_features_vector.qza \
  --m-metadata-file metadata.txt \
  --o-visualization core-metrics-results/observed_features_vector.qzv

qiime diversity beta-group-significance \
  --i-distance-matrix core-metrics-results/bray_curtis_distance_matrix.qza \
  --m-metadata-file metadata.txt \
  --m-metadata-column patient \
  --o-visualization core-metrics-results/bray-curtis-sex-significance.qzv \
  --p-pairwise

qiime diversity beta-group-significance \
  --i-distance-matrix core-metrics-results/bray_curtis_distance_matrix.qza \
  --m-metadata-file metadata.txt \
  --m-metadata-column treatment \
  --o-visualization core-metrics-results/bray-curtis-population-significance.qzv\
  --p-pairwise

